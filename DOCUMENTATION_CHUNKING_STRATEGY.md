# 文档分块策略文档

## 概述

本系统实现了先进的文档分块策略，结合了LangChain TextSplitter的强大功能和滑动窗口技术，特别针对中文文档进行了优化。系统现在采用显式的文本分块策略，而非依赖于文档加载器的默认行为。

## 分块策略特点

### 1. LangChain TextSplitter集成

- 使用 `RecursiveCharacterTextSplitter` 作为基础分割器
- 支持多层级分隔符，优先级依次为：
  - 段落分隔 (`\n\n`)
  - 换行符 (`\n`)  
  - 中文句号 (`。`)
  - 中文感叹号 (`！`)
  - 中文问号 (`？`)
  - 中文分号 (`；`)
  - 其他标点符号和空格

### 2. 中文优化

- 针对中文文档的特殊性，优化了分隔符序列
- 保持语义完整性，避免在句子中间切断
- 考虑中文标点符号的使用习惯

### 3. 滑动窗口策略

- 使用 `chunk_overlap` 参数实现滑动窗口效果
- 默认设置为 `chunk_size=500`, `chunk_overlap=50`
- 保持相邻块之间的上下文连续性

## 具体实现

### 1. 中文文本分割器
```python
# 创建中文优化的分割器
splitter = ChineseTextSplitter(
    chunk_size=500,      # 块大小
    chunk_overlap=50,    # 块重叠
    separators=[         # 分隔符优先级列表
        "\n\n",  # 段落分隔
        "\n",     # 换行符
        "。",      # 中文句号
        "！",      # 中文感叹号
        "？",      # 中文问号
        "；",      # 中文分号
        " ",      # 空格
        ""
    ]
)
```

### 2. 高级文档加载流程
- 根据文件扩展名选择合适的加载器
- 使用加载器初步加载文档内容
- 应用中文优化的分块策略进行二次处理
- 为每个文档块添加分块相关元数据（块大小、重叠、原始长度等）

### 3. 配置参数

#### 默认参数
- `chunk_size`: 500（每个文本块的最大字符数）
- `chunk_overlap`: 50（相邻文本块之间的重叠字符数）

#### 高级配置
可通过以下方式自定义参数：
```python
splitter = ChineseTextSplitter(
    chunk_size=600,      # 自定义块大小
    chunk_overlap=60,    # 自定义重叠大小
    separators=['\n\n', '\n', '。', '！', '？', ' ', '']  # 自定义分隔符
)
```

## API集成

分块策略已无缝集成到现有API中：

- `/upload/` 和 `/upload_batch/` 接口
- `/add_document/` 接口
- 所有文档加载和索引功能

## 性能优化

- 提升了中文文档的检索准确性
- 减少了语义断裂导致的信息丢失
- 平衡了索引效率和检索精度
- 保持了与现有系统的向后兼容性

## 使用建议

对于不同类型文档的推荐配置：

- **长篇文档**（如报告、手册）：`chunk_size=600-800`
- **学术论文**：`chunk_size=400-600`
- **新闻文章**：`chunk_size=300-500`
- **技术文档**：`chunk_size=500-700`

通过优化的分块策略，系统能更好地理解文档语义，提高问答准确性。